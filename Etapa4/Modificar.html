<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narices Frias</title>
    <link rel="stylesheet" href="./Estilos/Root.css">
<!---    <link rel="stylesheet" href="./Estilos/form.css"> -->
    <link rel="stylesheet" href="./Estilos/form.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <!--Fuente para titulo-->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sacramento&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/7eb605e564.js" crossorigin="anonymous"></script>
    <link rel="icon" href="media/favicon/dogPaw.ico" type="image/x-icon" >
</head>
<body>
    <!--Header-->
    <header>
            <img class="emblema"  src="./Media/logos/4.png" alt="logo">
            <h1 class="titulo">Narices Frías (Empleados)</h1>

    </header>

    <div class="topnav">
        <a href="./Listado.html">Listado</a>
        <a href="./Agregar.html">Agregar</a>
        <a href="./Modificar.html">Modificar</a>
        <a href="./Eliminar.html">Eliminar</a>
    </div>


<!--body-->
    <div class="cuerpo">
        <div class="bloque bloque1">
        <h1 class="subtitulo sb1">Modificar datos del cachorro</h1>
        <!--Formulario 1: Ingreso del codigo para llamar la funcion obtenerProducto cuando se envíe el formulario-->
        <form  id="form-obtener-cachorro">
            <label for="Codigo"> Cachorro: </label>
            <input type="text" id="Codigo" required>
            <button type="submit">Modificar Cachorro</button>
        </form>

        <!--Formulario 2: Ingreso de datos para modificar el cachorro-->
        <div id="datos-cachorro" style="display: none;">
        <h2>Datos del cachorro</h2>
        <form id="form-guardar-cambios">
            <label for="nombreModificar">Nombre:</label>
            <input type="text" id="nombreModificar" required><br>

            <label for="generoModificar">Genero:</label>
            <input type="radio" name="generoModificar" value="Macho"><br>
            <label>Macho</label>
            <input type="radio" name="generoModificar" value="Hembra"><br>
            <label>Hembra</label>

            <label for="edadModificar">Edad:</label>
            <input type="radio" name="edadModificar" value="Cachorro"><br>
            <label>Cachorro</label>
            <input type="radio" name="edadModificar" value="Adulto"><br>
            <label>Adulto</label>

            <!-- Imagen actual del producto - Debe comentarse al subirse al servidor-->
            <img id="imagen-actual" style="max-width: 200px; display: none;">               
            <!-- Vista previa de la nueva imagen seleccionada -->
            <img id="imagen-vista-previa" style="max-width: 200px; display: none;">

            <!-- Input para nueva imagen -->
            <label for="nuevaImagen">Nueva Imagen:</label>
            <input type="file" id="nuevaImagen"><br>

            <button type="submit">Guardar Cambios</button>
            <a href="Modificar.html">Cancelar</a>
        </form>
        </div>

    </div>
    </div>
    <!--footer-->
    <footer id="footerDiv">
    <div class="tituloFooter">
        <div class="line"></div><h3>Narices Frias</h3><div class="line"></div>
    </div>
    <ul>
        <li> <a href="#"><i class="fa-brands fa-facebook fa-xl" style="color: #ffe6e6;" >&nbsp;</i></a> </li>
        <li> <a href="#"><i class="fa-brands fa-x-twitter fa-xl" style="color: #fae6e6;">&nbsp;</i></a> </li>
        <li> <a href="#"><i class="fa-brands fa-instagram fa-xl" style="color: #fae6e6;">&nbsp;</i></a> </li>
        <li> <a href="#"><i class="fa-brands fa-pinterest-p fa-xl" style="color: #fae6e6;">&nbsp;</i></a></li>
    </ul>
    <p>Copyright 2.024 © <b>Narices Frias</b> Todos los derechos reservados.</p>
</footer>



<script>
    const URL = "http://127.0.0.1:5000/"


    // Al subir al servidor, deberá utilizarse la siguiente ruta. USUARIO debe ser reemplazado por el nombre de usuario de Pythonanywhere
    //const URL = "https://USUARIO.pythonanywhere.com/"

    // Variables de estado para controlar la visibilidad y los datos del formulario
    let codigo = '';
    let nombre = '';
    let genero = '';
    let edad = '';
    let imagen_url = '';
    let imagenSeleccionada = null;
    let imagenUrlTemp = null;
    let mostrarDatosCachorro = false;

    document.getElementById('form-obtener-cachorro').addEventListener('submit', obtenerCachorro);
    document.getElementById('form-guardar-cambios').addEventListener('submit', guardarCambios);
    document.getElementById('nuevaImagen').addEventListener('change', seleccionarImagen);

    // Se ejecuta cuando se envía el formulario de consulta. Realiza una solicitud GET a la API y obtiene los datos del producto correspondiente al código ingresado.
    function obtenerCachorro(event) {
        event.preventDefault();
        codigo = document.getElementById('Codigo').value;
        fetch(URL + 'cachorros/' + codigo)
            .then(response => {
                if (response.ok) {
                    return response.json()
                } else {
                    throw new Error('Error al obtener los datos del producto.')
                }
            })
            .then(data => {
                nombre = data.nombre;
                genero = data.genero;
                edad = data.edad;
                imagen_url = data.imagen_url;
                mostrarDatosCachorro = true; //Activa la vista del segundo formulario
                mostrarFormulario();
            })
            .catch(error => {
                alert('Código no encontrado.');
            });
    }

    // Muestra el formulario con los datos del producto
    function mostrarFormulario() {
        if (mostrarDatosCachorro) {
            document.getElementById('descripcionModificar').value = descripcion;
            document.getElementById('cantidadModificar').value = cantidad;
            document.getElementById('precioModificar').value = precio;
            document.getElementById('proveModificar').value = proveedor;

            const imagenActual = document.getElementById('imagen-actual');
            if (imagen_url && !imagenSeleccionada) { // Verifica si imagen_url no está vacía y no se ha seleccionado una imagen
                
                 imagenActual.src = './static/imagenes/' + imagen_url;                    
  //Al subir al servidor, deberá utilizarse la siguiente ruta. USUARIO debe ser reemplazado por el nombre de usuario de Pythonanywhere
                //imagenActual.src = 'https://www.pythonanywhere.com/user/USUARIO/files/home/USUARIO/mysite/static/imagenes/' + imagen_url;
                imagenActual.style.display = 'block'; // Muestra la imagen actual
            } else {
                imagenActual.style.display = 'none'; // Oculta la imagen si no hay URL
            }

            document.getElementById('datos-cachorro').style.display = 'block';
        } else {
            document.getElementById('datos-cachorro').style.display = 'none';
        }
    }

    // Se activa cuando el usuario selecciona una imagen para cargar.
    function seleccionarImagen(event) {
        const file = event.target.files[0];
        imagenSeleccionada = file;
        imagenUrlTemp = URL.createObjectURL(file); // Crea una URL temporal para la vista previa

        const imagenVistaPrevia = document.getElementById('imagen-vista-previa');
        imagenVistaPrevia.src = imagenUrlTemp;
        imagenVistaPrevia.style.display = 'block';
    }

    // Se usa para enviar los datos modificados del producto al servidor.
    function guardarCambios(event) {
        event.preventDefault();

        const formData = new FormData();
        formData.append('Codigo', codigo);
        formData.append('Nombre', document.getElementById('nombreModificar').value);
        formData.append('Genero', document.getElementById('generoModificar').value);
        formData.append('Edad', document.getElementById('edadModificar').value);

        // Si se ha seleccionado una imagen nueva, la añade al formData. 
        if (imagenSeleccionada) {
            formData.append('imagen', imagenSeleccionada, imagenSeleccionada.name);
        }

        fetch(URL + 'productos/' + codigo, {
            method: 'PUT',
            body: formData,
        })
            .then(response => {
                if (response.ok) {
                    return response.json()
                } else {
                    throw new Error('Error al guardar los cambios del producto.')
                }
            })
            .then(data => {
                alert('Producto actualizado correctamente.');
                limpiarFormulario();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al actualizar el producto.');
            });
    }

    // Restablece todas las variables relacionadas con el formulario a sus valores iniciales, lo que efectivamente "limpia" el formulario.
    function limpiarFormulario() {
        document.getElementById('codigo').value = '';
        document.getElementById('nombreModificar').value = '';
        document.getElementById('generoModificar').value = '';
        document.getElementById('edadModificar').value = '';
        document.getElementById('nuevaImagen').value = '';

        const imagenActual = document.getElementById('imagen-actual');
        imagenActual.style.display = 'none';

        const imagenVistaPrevia = document.getElementById('imagen-vista-previa');
        imagenVistaPrevia.style.display = 'none';

        codigo = '';
        nombre = '';
        genero = '';
        edad = '';
        imagen_url = '';
        imagenSeleccionada = null;
        imagenUrlTemp = null;
        mostrarDatosCachorro = false;

        document.getElementById('datos-cachorro').style.display = 'none';
    }
</script>

</body>
</html>